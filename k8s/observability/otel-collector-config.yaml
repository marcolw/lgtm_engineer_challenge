apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: otel-collector
data:
  otel-collector-config: |
    receivers:
      # OTLP Receiver: Accepts data from the Python/Go/Node apps
      otlp:
        protocols:
          grpc:
            endpoint: "0.0.0.0:4317"
          http:
            endpoint: "0.0.0.0:4318"

    processors:
      # Batching is crucial for efficiency
      batch:
      # Use the k8s attributes processor to enrich telemetry with pod/node labels
      k8sattributes:
        auth_type: "kubeConfig"
        extract:
          metadata:
            - "k8s.namespace.name"
            - "k8s.deployment.name"
            - "k8s.pod.name"
            - "k8s.node.name"

    exporters:
      # TRACES -> Tempo
      otlp/tempo:
        endpoint: "tempo.monitoring.svc.cluster.local:4317"
        tls:
          insecure: true # Use insecure for internal cluster comms
      
      # METRICS -> Prometheus Remote Write Endpoint
      # Note: We must use the Prometheus remote_write protocol for metrics
      # This points to the Prometheus server service deployed by kube-prometheus-stack
      prometheusremotewrite:
        endpoint: "http://prometheus-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"

      # LOGS -> Loki via HTTP/Protobuf
      otlp/loki:
        endpoint: "http://loki-gateway.monitoring.svc.cluster.local:3100"
        compression: gzip
        tls:
          insecure: true

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [otlp/tempo]
        metrics:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [prometheusremotewrite]
        logs:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [otlp/loki]